<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ComplianceReader - Document Reader</title>
  
  <!-- PDF.js -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      overflow-x: hidden;
    }

    /* ===== TOOLBAR ===== */
    #toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: white;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .toolbar-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #764ba2;
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: #f5f5f5;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: #e5e5e5;
    }

    .btn-icon.sync-active {
      background: #667eea;
      color: white;
    }

    #pageInfo {
      font-size: 14px;
      color: #666;
      min-width: 100px;
      text-align: center;
    }

    /* ===== READER CONTAINER ===== */
    #readerContainer {
      margin-top: 60px;
      margin-bottom: 100px;
      padding: 20px;
      min-height: calc(100vh - 160px);
    }

    #pdfViewer {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    #pdfViewer canvas {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      height: auto;
    }

    /* ===== COMPREHENSION BAR ===== */
    #comprehensionBar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: white;
      border-top: 1px solid #ddd;
      z-index: 1000;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }

    #emotionHeatmap {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(
        to right,
        #e74c3c,
        #f39c12,
        #3498db,
        #27ae60,
        #f1c40f,
        #e67e22,
        #c0392b,
        #ffd700
      );
      display: flex;
    }

    .emotion-zone {
      flex: 1;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .emotion-zone:hover {
      filter: brightness(1.2);
      transform: scaleY(1.2);
    }

    .emotion-zone:hover::after {
      content: attr(data-label);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      margin-bottom: 8px;
    }

    #comprehensionInfo {
      padding: 20px;
      text-align: center;
      font-size: 14px;
      color: #666;
    }

    /* ===== EMOTION POPUP ===== */
    #emotionPopup {
      display: none;
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 2000;
      min-width: 300px;
      text-align: center;
    }

    #emotionPopup.active {
      display: block;
    }

    #emotionPopup h3 {
      margin-bottom: 12px;
      color: #333;
    }

    #emotionPopup .buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    #emotionPopup button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    #emotionPopup .btn-confirm {
      background: #667eea;
      color: white;
    }

    #emotionPopup .btn-cancel {
      background: #f5f5f5;
      color: #333;
    }

    /* ===== SYNC MODAL ===== */
    #syncModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }

    #syncModal.active {
      display: flex;
    }

    .sync-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }

    .sync-box h3 {
      font-size: 24px;
      margin-bottom: 16px;
    }

    .sync-box p {
      color: #666;
      margin-bottom: 20px;
    }

    #syncRoomCode {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      letter-spacing: 4px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
    }

    .sync-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .sync-actions button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sync-actions .btn-reader {
      background: #667eea;
      color: white;
    }

    .sync-actions .btn-listener {
      background: #27ae60;
      color: white;
    }

    .sync-actions .btn-hangup {
      background: #e74c3c;
      color: white;
    }

    /* ===== PROGRESS INDICATOR ===== */
    #progressBar {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      height: 4px;
      background: #f5f5f5;
      z-index: 999;
    }

    #progressFill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s;
    }

    /* ===== LOADING ===== */
    .loading {
      text-align: center;
      padding: 60px;
      color: #666;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      #toolbar {
        height: 50px;
        padding: 0 10px;
      }

      .toolbar-section {
        gap: 6px;
      }

      .btn {
        padding: 6px 12px;
        font-size: 12px;
      }

      .btn-icon {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }

      #readerContainer {
        padding: 10px;
        margin-top: 50px;
      }

      #comprehensionBar {
        height: 50px;
      }

      #comprehensionInfo {
        padding: 12px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- TOOLBAR -->
  <div id="toolbar">
    <div class="toolbar-section">
      <a href="library.html" class="btn">‚Üê Library</a>
      <button id="prevBtn" class="btn-icon" title="Previous Page">‚Üê</button>
      <button id="nextBtn" class="btn-icon" title="Next Page">‚Üí</button>
    </div>

    <div class="toolbar-section">
      <div id="pageInfo">Loading...</div>
    </div>

    <div class="toolbar-section">
      <button id="syncBtn" class="btn-icon" title="Screen Sync">üîÑ</button>
      <a href="dashboard.html" class="btn">üìä Dashboard</a>
    </div>
  </div>

  <!-- PROGRESS BAR -->
  <div id="progressBar">
    <div id="progressFill"></div>
  </div>

  <!-- READER CONTAINER -->
  <div id="readerContainer">
    <div id="pdfViewer">
      <div class="loading">Loading document...</div>
    </div>
  </div>

  <!-- COMPREHENSION BAR -->
  <div id="comprehensionBar">
    <div id="emotionHeatmap">
      <div class="emotion-zone" data-emotion="confused" data-label="üòï Confused"></div>
      <div class="emotion-zone" data-emotion="clarification" data-label="ü§î Need Clarification"></div>
      <div class="emotion-zone" data-emotion="following" data-label="üìñ Following Along"></div>
      <div class="emotion-zone" data-emotion="understood" data-label="‚úÖ Clear"></div>
      <div class="emotion-zone" data-emotion="aha" data-label="üí° Aha Moment"></div>
      <div class="emotion-zone" data-emotion="important" data-label="‚ö†Ô∏è Important"></div>
      <div class="emotion-zone" data-emotion="remember" data-label="üéØ Must Remember"></div>
      <div class="emotion-zone" data-emotion="excellent" data-label="‚ú® Excellent"></div>
    </div>
    <div id="comprehensionInfo">
      Tap the colored bar above to track your comprehension
    </div>
  </div>

  <!-- EMOTION POPUP -->
  <div id="emotionPopup">
    <h3 id="emotionLabel"></h3>
    <p>Mark this section as:</p>
    <div class="buttons">
      <button class="btn-confirm" onclick="confirmEmotion()">Confirm</button>
      <button class="btn-cancel" onclick="cancelEmotion()">Cancel</button>
    </div>
  </div>

  <!-- SYNC MODAL -->
  <div id="syncModal">
    <div class="sync-box">
      <h3>üì° Screen Sync</h3>
      <p>Connect two devices for training sessions</p>
      <div id="syncRoomMeta">
        <div>Room Code:</div>
        <div id="syncRoomCode">‚Äî</div>
      </div>
      <div class="sync-actions">
        <button class="btn-reader" id="syncSendBtn">Reader</button>
        <button class="btn-listener" id="syncReceiveBtn">Listener</button>
        <button class="btn-hangup" id="syncHangupBtn">Hang Up</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    const SUPABASE_URL = 'https://tbkdigmhjtnibqfgmptq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRia2RpZ21oanRuaWJxZmdtcHRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODAwMTIsImV4cCI6MjA3NzA1NjAxMn0.j9ICEt45q6a3UsRbm5W55_k0s6SjVgqJm3fpDNjpMVw';

    // PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

    let supabaseClient;
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 0;
    let pageRendering = false;
    let pageNumPending = null;
    let currentDocId = null;
    let currentDocSlug = null;
    let sessionStart = Date.now();
    let pageStartTime = Date.now();
    let selectedEmotion = null;

    // Demo user ID (in production, this would come from authentication)
    const DEMO_USER_ID = 'b0000000-0000-0000-0000-000000000001';

    // ============================================================================
    // INITIALIZE
    // ============================================================================

    function initSupabase() {
      try {
        if (typeof window.supabase === 'undefined') {
          throw new Error('Supabase library not loaded');
        }
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('‚úÖ Supabase initialized');
        return true;
      } catch (err) {
        console.error('‚ùå Supabase init failed:', err);
        return false;
      }
    }

    // ============================================================================
    // PDF RENDERING
    // ============================================================================

    async function renderPage(num) {
      if (pageRendering) {
        pageNumPending = num;
        return;
      }
      
      pageRendering = true;
      currentPage = num;
      
      // Update UI
      document.getElementById('pageInfo').textContent = `Page ${num} of ${totalPages}`;
      document.getElementById('progressFill').style.width = `${(num / totalPages) * 100}%`;

      // Save time spent on previous page
      if (pageStartTime) {
        const timeSpent = Math.floor((Date.now() - pageStartTime) / 1000);
        await savePageAnalytics(currentPage - 1, timeSpent);
      }
      pageStartTime = Date.now();

      try {
        const page = await pdfDoc.getPage(num);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({
          canvasContext: ctx,
          viewport: viewport
        }).promise;

        const viewer = document.getElementById('pdfViewer');
        viewer.innerHTML = '';
        viewer.appendChild(canvas);

        pageRendering = false;
        
        if (pageNumPending !== null) {
          const pending = pageNumPending;
          pageNumPending = null;
          renderPage(pending);
        }
      } catch (error) {
        console.error('Error rendering page:', error);
        pageRendering = false;
      }
    }

    async function loadPDF(url) {
      try {
        const loadingTask = pdfjsLib.getDocument(url);
        pdfDoc = await loadingTask.promise;
        totalPages = pdfDoc.numPages;
        console.log(`‚úÖ PDF loaded: ${totalPages} pages`);
        
        renderPage(1);
      } catch (error) {
        console.error('Error loading PDF:', error);
        document.getElementById('pdfViewer').innerHTML = `
          <div class="loading" style="color: #e74c3c;">
            <h3>Error Loading Document</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // ============================================================================
    // NAVIGATION
    // ============================================================================

    function nextPage() {
      if (currentPage >= totalPages) return;
      renderPage(currentPage + 1);
    }

    function prevPage() {
      if (currentPage <= 1) return;
      renderPage(currentPage - 1);
    }

    // ============================================================================
    // ANALYTICS
    // ============================================================================

    async function savePageAnalytics(pageNum, timeSpent) {
      if (!currentDocId || pageNum < 1) return;
      
      try {
        const { error } = await supabaseClient
          .from('page_analytics')
          .insert({
            user_id: DEMO_USER_ID,
            document_id: currentDocId,
            organization_id: 'a0000000-0000-0000-0000-000000000001',
            page_number: pageNum,
            time_spent_seconds: timeSpent,
            session_id: crypto.randomUUID(),
            entered_at: new Date().toISOString()
          });

        if (error) console.error('Analytics error:', error);
        else console.log(`üìä Saved analytics: page ${pageNum}, ${timeSpent}s`);
      } catch (err) {
        console.error('Failed to save analytics:', err);
      }
    }

    async function saveComprehension(emotion) {
      if (!currentDocId) return;

      try {
        const { error } = await supabaseClient
          .from('page_analytics')
          .insert({
            user_id: DEMO_USER_ID,
            document_id: currentDocId,
            organization_id: 'a0000000-0000-0000-0000-000000000001',
            page_number: currentPage,
            time_spent_seconds: 0,
            session_id: crypto.randomUUID(),
            entered_at: new Date().toISOString(),
            metadata: { comprehension: emotion }
          });

        if (error) console.error('Comprehension error:', error);
        else console.log(`üí≠ Saved comprehension: ${emotion} on page ${currentPage}`);
      } catch (err) {
        console.error('Failed to save comprehension:', err);
      }
    }

    // ============================================================================
    // COMPREHENSION BAR
    // ============================================================================

    const emotionLabels = {
      'confused': 'üòï Confused - I don\'t understand this',
      'clarification': 'ü§î Need Clarification - Needs better explanation',
      'following': 'üìñ Following Along - Makes sense so far',
      'understood': '‚úÖ Clear & Understood - Got it!',
      'aha': 'üí° Aha Moment - Now I understand!',
      'important': '‚ö†Ô∏è Important - This is critical',
      'remember': 'üéØ Must Remember - Key takeaway',
      'excellent': '‚ú® Excellent - Great explanation!'
    };

    function showEmotionPopup(emotion) {
      selectedEmotion = emotion;
      document.getElementById('emotionLabel').textContent = emotionLabels[emotion];
      document.getElementById('emotionPopup').classList.add('active');
    }

    function confirmEmotion() {
      if (selectedEmotion) {
        saveComprehension(selectedEmotion);
        document.getElementById('emotionPopup').classList.remove('active');
        selectedEmotion = null;
      }
    }

    function cancelEmotion() {
      document.getElementById('emotionPopup').classList.remove('active');
      selectedEmotion = null;
    }

    // ============================================================================
    // SCREEN SYNC
    // ============================================================================

    let syncChannel = null;
    let syncRoomId = null;
    let isReader = false;

    function openSyncModal() {
      document.getElementById('syncModal').classList.add('active');
    }

    function closeSyncModal() {
      document.getElementById('syncModal').classList.remove('active');
    }

    async function startReaderMode() {
      if (syncChannel) {
        alert('Already connected. Hang up first.');
        return;
      }

      isReader = true;
      syncRoomId = Math.random().toString(36).slice(2, 8).toUpperCase();
      document.getElementById('syncRoomCode').textContent = syncRoomId;

      const channelName = `compliance-room-${syncRoomId}`;
      syncChannel = supabaseClient.channel(channelName, {
        config: {
          broadcast: { ack: false, self: false }
        }
      });

      await syncChannel.subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          console.log('üéôÔ∏è Broadcasting:', syncRoomId);
          document.getElementById('syncBtn').classList.add('sync-active');
        }
      });

      setTimeout(closeSyncModal, 1500);
    }

    async function startListenerMode() {
      if (syncChannel) {
        alert('Already connected. Hang up first.');
        return;
      }

      const roomCode = prompt('Enter room code from Reader device:');
      if (!roomCode) return;

      isReader = false;
      syncRoomId = roomCode.trim().toUpperCase();
      document.getElementById('syncRoomCode').textContent = syncRoomId;

      const channelName = `compliance-room-${syncRoomId}`;
      syncChannel = supabaseClient.channel(channelName);

      syncChannel.on('broadcast', { event: 'page-change' }, ({ payload }) => {
        if (!isReader && payload.page) {
          console.log('üì• Received page:', payload.page);
          renderPage(payload.page);
        }
      });

      await syncChannel.subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          console.log('üéß Listening:', syncRoomId);
          document.getElementById('syncBtn').classList.add('sync-active');
        }
      });

      setTimeout(closeSyncModal, 800);
    }

    async function hangupSync() {
      if (syncChannel) {
        await supabaseClient.removeChannel(syncChannel);
        console.log('üì¥ Disconnected');
      }

      syncChannel = null;
      syncRoomId = null;
      isReader = false;
      document.getElementById('syncBtn').classList.remove('sync-active');
      document.getElementById('syncRoomCode').textContent = '‚Äî';
      closeSyncModal();
    }

    // Broadcast page changes when in reader mode
    function broadcastPageChange(pageNum) {
      if (syncChannel && isReader) {
        syncChannel.send({
          type: 'broadcast',
          event: 'page-change',
          payload: { page: pageNum }
        });
        console.log('üì§ Broadcast page:', pageNum);
      }
    }

    // ============================================================================
    // LOAD DOCUMENT
    // ============================================================================

    async function loadDocument() {
      const params = new URLSearchParams(window.location.search);
      currentDocSlug = params.get('doc');

      if (!currentDocSlug) {
        document.getElementById('pdfViewer').innerHTML = `
          <div class="loading" style="color: #e74c3c;">
            <h3>No Document Specified</h3>
            <p><a href="library.html">Return to library</a></p>
          </div>
        `;
        return;
      }

      try {
        // Get document from database
        const { data: doc, error } = await supabaseClient
          .from('documents')
          .select('*')
          .eq('slug', currentDocSlug)
          .single();

        if (error || !doc) {
          throw new Error('Document not found');
        }

        currentDocId = doc.id;
        console.log('üìÑ Loading:', doc.title);

        // For demo, use a sample PDF
        // In production, use doc.external_url
        const samplePDFs = {
          'code-of-conduct-2024': 'https://www.ilo.org/wcmsp5/groups/public/---ed_dialogue/---lab_admin/documents/instructionalmaterial/wcms_111498.pdf',
          'data-privacy-gdpr-2024': 'https://gdpr.eu/wp-content/uploads/2019/01/GDPR.pdf',
          'cybersecurity-training-2024': 'https://www.cisa.gov/sites/default/files/publications/Cybersecurity%20Best%20Practices%20for%20Small%20and%20Medium%20Businesses.pdf',
          'harassment-prevention-2024': 'https://www.ilo.org/wcmsp5/groups/public/---ed_dialogue/---lab_admin/documents/instructionalmaterial/wcms_111498.pdf',
          'financial-controls-sox-2024': 'https://pcaobus.org/oversight/standards/auditing-standards/details/AS2201'
        };

        const pdfUrl = samplePDFs[currentDocSlug] || samplePDFs['code-of-conduct-2024'];
        
        await loadPDF(pdfUrl);

      } catch (error) {
        console.error('Error loading document:', error);
        document.getElementById('pdfViewer').innerHTML = `
          <div class="loading" style="color: #e74c3c;">
            <h3>Error Loading Document</h3>
            <p>${error.message}</p>
            <p><a href="library.html">Return to library</a></p>
          </div>
        `;
      }
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================

    document.getElementById('prevBtn').addEventListener('click', prevPage);
    document.getElementById('nextBtn').addEventListener('click', nextPage);
    document.getElementById('syncBtn').addEventListener('click', openSyncModal);
    document.getElementById('syncSendBtn').addEventListener('click', startReaderMode);
    document.getElementById('syncReceiveBtn').addEventListener('click', startListenerMode);
    document.getElementById('syncHangupBtn').addEventListener('click', hangupSync);
    document.getElementById('syncModal').addEventListener('click', (e) => {
      if (e.target.id === 'syncModal') closeSyncModal();
    });

    // Comprehension bar clicks
    document.querySelectorAll('.emotion-zone').forEach(zone => {
      zone.addEventListener('click', () => {
        const emotion = zone.dataset.emotion;
        showEmotionPopup(emotion);
      });
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight' || e.key === 'PageDown') nextPage();
      if (e.key === 'ArrowLeft' || e.key === 'PageUp') prevPage();
    });

    // Intercept page changes for sync
    const originalRenderPage = renderPage;
    renderPage = async function(num) {
      await originalRenderPage(num);
      broadcastPageChange(num);
    };

    // Save analytics on page unload
    window.addEventListener('beforeunload', () => {
      const timeSpent = Math.floor((Date.now() - pageStartTime) / 1000);
      savePageAnalytics(currentPage, timeSpent);
    });

    // ============================================================================
    // INIT
    // ============================================================================

    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Reader initializing...');
      
      setTimeout(() => {
        if (initSupabase()) {
          loadDocument();
        }
      }, 100);
    });
  </script>
</body>
</html>
